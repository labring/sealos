project_name: sealos
#gomod:
#  # Proxy a module from proxy.golang.org, making the builds verifiable.
#  # This will only be effective if running against a tag. Snapshots will ignore this setting.
#  # Notice: for this to work your `build.main` must be a package, not a `.go` file.
#  #
#  # Default is false.
#  proxy: true
#
#  # If proxy is true, use these environment variables when running `go mod` commands (namely, `go mod tidy`).
#  # Defaults to `os.Environ()`.
#  env:
#    - GOPROXY=https://goproxy.cn

before:
  hooks:
    - make clean
    - go generate ./...
    - go mod tidy
builds:
  - id: sealos
    env:
      - CGO_ENABLED=1
      - CC=aarch64-linux-gnu-gcc
      - CC_FOR_TARGET=gcc-aarch64-linux-gnu
      - PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig/
    main: ./cmd/sealos
    binary: sealos
    hooks:
      post: upx "{{ .Path }}"
    goos:
      - linux
    goarch:
      - arm64
      - amd64
    flags:
      - -trimpath
    tags:
      - containers_image_openpgp
      - netgo
      - exclude_graphdriver_devicemapper
      - static
      - osusergo
      - exclude_graphdriver_btrfs
    ldflags:
      - -X github.com/labring/sealos/pkg/version.gitVersion={{.Version}}
      - -X github.com/labring/sealos/pkg/version.gitCommit={{.ShortCommit}}
      - -X github.com/labring/sealos/pkg/version.buildDate={{.Date}}
      - -extldflags "-static -fpic"
      - -s -w
      - -linkmode external
    overrides:
      - goos: linux
        goarch: amd64
        goamd64: v1
        goarm: ""
        gomips: ""
        env:
          - CGO_ENABLED=1
          - CC=x86_64-linux-gnu-gcc
          - CC_FOR_TARGET=gcc-x86_64-linux-gnu
          - PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig/

  - id: sealctl
    env:
      - CGO_ENABLED=0
    main: ./cmd/sealctl
    hooks:
      post: upx "{{ .Path }}"
    binary: sealctl
    goos:
      - linux
    goarch:
      - arm64
      - amd64
    flags:
      - -trimpath
    ldflags:
      - -X github.com/labring/sealos/pkg/version.gitVersion={{.Version}}
      - -X github.com/labring/sealos/pkg/version.gitCommit={{.ShortCommit}}
      - -X github.com/labring/sealos/pkg/version.buildDate={{.Date}}
      - -s -w

  - id: lvscare
    env:
      - CGO_ENABLED=0
    main: ./cmd/lvscare
    hooks:
      post: upx "{{ .Path }}"
    binary: lvscare
    goos:
      - linux
    goarch:
      - arm64
      - amd64
    flags:
      - -trimpath
    ldflags:
      - -X github.com/labring/sealos/pkg/version.gitVersion={{.Version}}
      - -X github.com/labring/sealos/pkg/version.gitCommit={{.ShortCommit}}
      - -X github.com/labring/sealos/pkg/version.buildDate={{.Date}}
      - -s -w

  - id: image-cri-shim
    env:
      - CGO_ENABLED=0
    main: ./cmd/image-cri-shim
    hooks:
      post: upx "{{ .Path }}"
    binary: image-cri-shim
    goos:
      - linux
    goarch:
      - arm64
      - amd64
    flags:
      - -trimpath
    ldflags:
      - -X github.com/labring/sealos/pkg/version.gitVersion={{.Version}}
      - -X github.com/labring/sealos/pkg/version.gitCommit={{.ShortCommit}}
      - -X github.com/labring/sealos/pkg/version.buildDate={{.Date}}
      - -s -w

release:
  github:
    owner: labring
    name: sealos
  prerelease: auto

dockers:
  - use: buildx
    ids:
      - lvscare
    goos: linux
    goarch: amd64
    image_templates:
      - lvscare:{{ .Tag }}-amd64
    dockerfile: docker/lvscare/Dockerfile
    build_flag_templates:
      - --pull
      - --platform=linux/amd64
  - use: buildx
    ids:
      - lvscare
    goos: linux
    goarch: arm64
    image_templates:
      - lvscare:{{ .Tag }}-arm64
    dockerfile: docker/lvscare/Dockerfile
    build_flag_templates:
      - --pull
      - --platform=linux/arm64
docker_manifests:
  - name_template: ghcr.io/labring/lvscare:{{ .Tag }}
    image_templates:
      - lvscare:{{ .Tag }}-amd64
      - lvscare:{{ .Tag }}-arm64

nfpms:
  - builds:
      - sealos
      - sealctl
    vendor: labring
    homepage: https://github.com/labring/sealos
    maintainer: fanux (https://github.com/fanux)
    description: Cloud OS distribution with Kubernetes as kernel
    license: Apache 2.0
    formats:
      - deb
      - rpm

publishers:
  - name: "fury.io"
    env:
      - TOKEN={{ .Env.FURY_TOKEN }}
    dir: "{{ dir .ArtifactPath }}"
    cmd: |
      curl -F package=@sealos_{{ .Tag }}_linux_amd64.deb https://$TOKEN@push.fury.io/labring/
      curl -F package=@sealos_{{ .Tag }}_linux_amd64.rpm https://$TOKEN@push.fury.io/labring/
      curl -F package=@sealos_{{ .Tag }}_linux_arm64.deb https://$TOKEN@push.fury.io/labring/
      curl -F package=@sealos_{{ .Tag }}_linux_arm64.rpm https://$TOKEN@push.fury.io/labring/

checksum:
  disable: true
  name_template: "{{ .ProjectName }}_checksums.txt"

snapshot:
  name_template: "{{ .Tag }}-next"

changelog:
  use: github
  sort: asc
  groups:
    - title: Features
      regexp: "^.*feat[(\\w)]*:+.*$"
      order: 0
    - title: "Bug fixes"
      regexp: "^.*fix[(\\w)]*:+.*$"
      order: 1
    - title: Others
      order: 999
  filters:
    exclude:
      - "^docs:"
      - "^test:"
