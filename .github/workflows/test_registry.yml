name: Test Saelctl Registry Command

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/test_registry.yml"
      - "fork/github.com/heroku/**"
      - "pkg/registry/**"
  pull_request:
    branches: ["*"]
    paths:
      - ".github/workflows/test_registry.yml"
      - "fork/github.com/heroku/**"
      - "pkg/registry/**"

jobs:
  build:
    uses: ./.github/workflows/import-patch-image.yml
    with:
      arch: amd64
      e2e: false
      image: false

  verify-registry-save:
    needs: [build]
    runs-on: ubuntu-20.04
    steps:
      - name: Download sealos
        uses: actions/download-artifact@v3
        with:
          name: sealos-amd64
          path: /tmp/
      - name: Download sealctl
        uses: actions/download-artifact@v3
        with:
          name: sealctl-amd64
          path: /tmp/
      - name: Verify sealctl
        run: |
          sudo chmod a+x /tmp/{sealos,sealctl}
          sudo mv /tmp/{sealos,sealctl} /usr/bin/
          sudo sealctl version
          sudo sealos version
#      - name: Verify Registry save raw
#        run: |
#          sudo docker logout docker.io
#          docker logout docker.io
#          sealctl logout docker.io
#          mkdir -p raw-amd64
#          sealctl registry save raw --images alpine:3.14 --images nginx:1.23.3 --images busybox:1.35 --data-dir raw-amd64 --arch amd64 --max-pull-procs 8 --debug
#          mkdir -p raw-arm64
#          sealctl registry save raw --images alpine:3.14 --images nginx:1.23.3 --images busybox:1.35 --data-dir raw-arm64 --arch arm64 --max-pull-procs 8 --debug
#      - name: Verify Registry save default
#        run: |
#          mkdir -p default
#          mkdir -p images/shim
#          cat >> images/shim/images <<EOF
#          alpine:3.14
#          nginx:1.23.3
#          busybox:1.35
#          EOF
#          sealctl registry save default  --data-dir default --max-pull-procs 8 --debug .
