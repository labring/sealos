name: Build Frontends Image

on:
  workflow_call:
    inputs:
      push_image:
        description: "Push image"
        required: false
        type: boolean
        default: false
      push_image_tag:
        description: "Push image tag"
        default: "latest"
        required: false
        type: string
  workflow_dispatch:
    inputs:
      push_image:
        description: "Push image"
        required: false
        type: boolean
        default: false
      push_image_tag:
        description: "Push image tag"
        default: "latest"
        required: false
        type: string
  push:
    branches: ["*"]
    paths:
      - "frontend/desktop/**"
      - "frontend/providers/**"
      - "frontend/packages/**"
      - "frontend/package.json"
      - "frontend/pnpm-lock.yaml"
      - "frontend/pnpm-workspace.yaml"
      - "frontend/tsconfig*.json"
      - ".github/workflows/frontend.yml"
      - ".github/workflows/frontends.yml"
      - "!**/*.md"
      - "!**/*.yaml"
  pull_request:
    branches: ["*"]
    paths:
      - "frontend/desktop/**"
      - "frontend/providers/**"
      - "frontend/packages/**"
      - "frontend/package.json"
      - "frontend/pnpm-lock.yaml"
      - "frontend/pnpm-workspace.yaml"
      - "frontend/tsconfig*.json"
      - ".github/workflows/frontend.yml"
      - ".github/workflows/frontends.yml"
      - "!**/*.md"
      - "!**/*.yaml"

jobs:
  # Detect which modules have changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      build-all: ${{ steps.check-build-all.outputs.result }}
      aiproxy: ${{ steps.filter.outputs.aiproxy }}
      license: ${{ steps.filter.outputs.license }}
      cronjob: ${{ steps.filter.outputs.cronjob }}
      template: ${{ steps.filter.outputs.template }}
      applaunchpad: ${{ steps.filter.outputs.applaunchpad }}
      terminal: ${{ steps.filter.outputs.terminal }}
      dbprovider: ${{ steps.filter.outputs.dbprovider }}
      costcenter: ${{ steps.filter.outputs.costcenter }}
      objectstorage: ${{ steps.filter.outputs.objectstorage }}
      kubepanel: ${{ steps.filter.outputs.kubepanel }}
      workorder: ${{ steps.filter.outputs.workorder }}
      devbox: ${{ steps.filter.outputs.devbox }}
      desktop: ${{ steps.filter.outputs.desktop }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            packages:
              - 'frontend/packages/**'
            root-config:
              - 'frontend/package.json'
              - 'frontend/pnpm-lock.yaml'
              - 'frontend/pnpm-workspace.yaml'
              - 'frontend/tsconfig*.json'
              - '.github/workflows/frontend.yml'
              - '.github/workflows/frontends.yml'
            aiproxy:
              - 'frontend/providers/aiproxy/**'
            license:
              - 'frontend/providers/license/**'
            cronjob:
              - 'frontend/providers/cronjob/**'
            template:
              - 'frontend/providers/template/**'
            applaunchpad:
              - 'frontend/providers/applaunchpad/**'
            terminal:
              - 'frontend/providers/terminal/**'
            dbprovider:
              - 'frontend/providers/dbprovider/**'
            costcenter:
              - 'frontend/providers/costcenter/**'
            objectstorage:
              - 'frontend/providers/objectstorage/**'
            kubepanel:
              - 'frontend/providers/kubepanel/**'
            workorder:
              - 'frontend/providers/workorder/**'
            devbox:
              - 'frontend/providers/devbox/**'
            desktop:
              - 'frontend/desktop/**'
      - name: Check if all modules should be built
        id: check-build-all
        run: |
          if [[ "${{ steps.filter.outputs.packages }}" == "true" || "${{ steps.filter.outputs.root-config }}" == "true" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  # Build aiproxy
  build-aiproxy:
    needs: detect-changes
    if: needs.detect-changes.outputs.aiproxy == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/aiproxy
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build license
  build-license:
    needs: detect-changes
    if: needs.detect-changes.outputs.license == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/license
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build cronjob
  build-cronjob:
    needs: detect-changes
    if: needs.detect-changes.outputs.cronjob == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/cronjob
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build template
  build-template:
    needs: detect-changes
    if: needs.detect-changes.outputs.template == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/template
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build applaunchpad
  build-applaunchpad:
    needs: detect-changes
    if: needs.detect-changes.outputs.applaunchpad == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/applaunchpad
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build terminal
  build-terminal:
    needs: detect-changes
    if: needs.detect-changes.outputs.terminal == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/terminal
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build dbprovider
  build-dbprovider:
    needs: detect-changes
    if: needs.detect-changes.outputs.dbprovider == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/dbprovider
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build costcenter
  build-costcenter:
    needs: detect-changes
    if: needs.detect-changes.outputs.costcenter == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/costcenter
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build objectstorage
  build-objectstorage:
    needs: detect-changes
    if: needs.detect-changes.outputs.objectstorage == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/objectstorage
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build kubepanel
  build-kubepanel:
    needs: detect-changes
    if: needs.detect-changes.outputs.kubepanel == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/kubepanel
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build workorder
  build-workorder:
    needs: detect-changes
    if: needs.detect-changes.outputs.workorder == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/workorder
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build devbox
  build-devbox:
    needs: detect-changes
    if: needs.detect-changes.outputs.devbox == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: providers/devbox
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}

  # Build desktop
  build-desktop:
    needs: detect-changes
    if: needs.detect-changes.outputs.desktop == 'true' || needs.detect-changes.outputs.build-all == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit
    with:
      module: desktop
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag }}
