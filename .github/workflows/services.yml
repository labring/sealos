name: Build Services (Optimized)

on:
  workflow_call:
    inputs:
      push_image:
        description: "Push image"
        required: false
        type: boolean
        default: false
      push_image_tag:
        description: "Push image tag"
        default: "latest"
        required: false
        type: string
      disable_cilint:
        description: "Disable golangci-lint"
        default: false
        required: false
        type: boolean
      force_all:
        description: "Force build all modules (for release)"
        default: false
        required: false
        type: boolean
  workflow_dispatch:
    inputs:
      push_image:
        description: "Push image"
        required: false
        type: boolean
        default: false
      push_image_tag:
        description: "Push image tag"
        default: "latest"
        required: false
        type: string
      disable_cilint:
        description: "Disable golangci-lint"
        default: false
        required: false
        type: boolean
  push:
    branches: ["*"]
    paths:
      - "service/**"
      - "controllers/pkg/**"
      - "controllers/account/**"
      - ".github/workflows/services.yml"
      - ".github/workflows/service-build.yml"
      - "!**/*.md"
      - "!**/*.yaml"
  pull_request:
    branches: ["*"]
    paths:
      - "service/**"
      - "controllers/pkg/**"
      - "controllers/account/**"
      - ".github/workflows/services.yml"
      - ".github/workflows/service-build.yml"
      - "!**/*.md"
      - "!**/*.yaml"

env:
  GO_VERSION: "1.25"
  DEFAULT_OWNER: "labring"

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    outputs:
      modules: ${{ steps.detect.outputs.modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: detect
        run: |
          set -x

          # Determine base ref
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="origin/${{ github.event.repository.default_branch }}"
          fi

          # Check if force_all is true (for release builds) or workflow_dispatch (manual builds)
          FORCE_ALL="false"
          if [[ "${{ inputs.force_all }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FORCE_ALL="true"
          fi

          # Check if controller dependencies changed (cross-project dependency)
          # If only controller dependencies changed (no service code changes),
          # we need to force rebuild of all services that depend on those controllers
          if [[ "$FORCE_ALL" != "true" ]]; then
            SERVICE_CHANGES=$(git diff --name-only "$BASE_REF" HEAD | grep -c "^service/" || true)

            # If no service code changes but controller dependencies changed, force all
            if [[ "$SERVICE_CHANGES" -eq 0 ]]; then
              if git diff --name-only "$BASE_REF" HEAD | grep -qE "^controllers/(pkg|account)/"; then
                echo "Controller dependencies changed without service changes, forcing rebuild of dependent services"
                FORCE_ALL="true"
              fi
            fi
          fi

          echo "Base ref: $BASE_REF"
          echo "Force all: $FORCE_ALL"

          # Run detection script
          MODULES=$(bash scripts/detect-build-modules.sh service "$BASE_REF" "$FORCE_ALL")

          echo "Detected modules: $MODULES"
          echo "modules=$MODULES" >> $GITHUB_OUTPUT

  build-services:
    if: ${{ needs.detect-changes.outputs.modules != '[]' }}
    needs: [detect-changes]
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJSON(needs.detect-changes.outputs.modules) }}
    uses: ./.github/workflows/service-build.yml
    with:
      module: ${{ matrix.module.name }}
      push_image: ${{ (github.event_name == 'push') || (github.event_name == 'create') || (inputs.push_image == true) }}
      push_image_tag: ${{ inputs.push_image_tag || 'latest' }}
      disable_cilint: ${{ inputs.disable_cilint || false }}
    secrets: inherit
