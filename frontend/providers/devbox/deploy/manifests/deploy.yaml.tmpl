apiVersion: v1
kind: Namespace
metadata:
  labels:
    app: devbox-frontend
  name: devbox-frontend
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: devbox-frontend-config
  namespace: devbox-frontend
data:
  config.yaml: |-
    addr: :3000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: devbox-frontend
  namespace: devbox-frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: devbox-frontend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 25%
      maxSurge: 25%
  template:
    metadata:
      labels:
        app: devbox-frontend
    spec:
      initContainers:
        - name: devbox-frontend-init
          image: ghcr.io/labring/sealos-devbox-frontend:latest
          imagePullPolicy: Always
          env:
          - name: DATABASE_URL
            value: {{ .databaseUrl }} # -nsealos cm desktop-frontend-config ->database->global + devbox
          command:
          - sh
          - -c
          args:
          - |-
            cd /app/providers/devbox
            MIGRATION="20260125094114_add_template_repository_kind"
            HAS_MIGRATION=$(psql "$DATABASE_URL" -tAc "SELECT 1 FROM _prisma_migrations WHERE migration_name='${MIGRATION}' AND rolled_back_at IS NULL LIMIT 1;")
            if [ "$HAS_MIGRATION" = "1" ]; then
              prisma migrate deploy
              exit 0
            fi
            HAS_ENUM=$(psql "$DATABASE_URL" -tAc "SELECT 1 FROM pg_enum e JOIN pg_type t ON t.oid = e.enumtypid WHERE t.typname IN ('TemplateRepositoryKind','template_repository_kind') AND e.enumlabel = 'SERVICE' LIMIT 1;")
            if [ "$HAS_ENUM" = "1" ]; then
              prisma migrate resolve --applied "$MIGRATION"
            fi
            prisma migrate deploy
      containers:
        - name: devbox-frontend
          env:
            - name: NODE_TLS_REJECT_UNAUTHORIZED
              value: "{{ default "1" .tlsRejectUnauthorized }}"
            - name: DOCUMENT_URL_ZH
              value: https://sealos.run/docs/overview/intro
            - name: DOCUMENT_URL_EN
              value: https://sealos.io/docs/overview/intro
            - name: PRIVACY_URL_ZH
              value: https://sealos.run/docs/msa/privacy-policy
            - name: PRIVACY_URL_EN
              value: https://sealos.io/docs/msa/privacy-policy
            - name: SEALOS_DOMAIN
              value: {{ .cloudDomain }}
            - name: SSH_DOMAIN
              value: {{ default "" .sshDomain }}
            - name: INGRESS_SECRET
              value: wildcard-cert
            - name: REGISTRY_ADDR
              value: {{ .registryAddr }}
            - name: DEVBOX_AFFINITY_ENABLE
              value: 'true'
            - name: MONITOR_URL
              value: http://launchpad-monitor.sealos.svc.cluster.local:8428
            - name: ACCOUNT_URL
              value: http://account-service.account-system.svc.cluster.local:2333
            - name: ROOT_RUNTIME_NAMESPACE
              value: devbox-system
            - name: INGRESS_DOMAIN
              value: {{ .cloudDomain }}
            - name: CURRENCY_SYMBOL
              value: usd #  'shellCoin' | 'cny' | 'usd'
            - name: GPU_ENABLE
              value: 'false'
            - name: STORAGE_LIMIT
              value: 10Gi # default is 10Gi
            - name: RETAG_SVC_URL
              value: http://devbox-service.devbox-system.svc.cluster.local:8092
            - name: JWT_SECRET
              value: {{ .jwtSecret }} # -nsealos cm desktop-frontend-config ->jwt->Internal
            - name: REGION_UID
              value: {{ .regionUid }} # -nsealos cm desktop-frontend-config ->regionUid
            - name: DATABASE_URL
              value: {{ .databaseUrl }} # -nsealos cm desktop-frontend-config ->database->global + devbox
            - name: ENABLE_IMPORT_FEATURE
              value: 'false'
            - name: ENABLE_WEBIDE_FEATURE
              value: 'false'
            - name: ENABLE_ADVANCED_CONFIG
              value: 'false'
            - name: CPU_SLIDE_MARK_LIST
              value: '1,2,4,8,16'
            - name: MEMORY_SLIDE_MARK_LIST
              value: '2,4,8,16,32'
            - name: DEVBOX_DOMAIN_CHALLENGE_SECRET
              value: {{ .devboxDomainChallengeSecret }}
            - name: NFS_STORAGE_CLASS_NAME
              value: {{ default "nfs-csi" .nfsStorageClassName }}
            - name: CUSTOM_SCRIPTS
              value: '{{ default "[]" .customScripts }}'
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - 'ALL'
          resources:
            limits:
              cpu: 2000m
              memory: 2048Mi
            requests:
              cpu: 100m
              memory: 128Mi
          # do not modify this image, it is used for CI/CD
          image: ghcr.io/labring/sealos-devbox-frontend:latest
          imagePullPolicy: Always
          volumeMounts:
            - name: devbox-frontend-volume
              mountPath: /config.yaml
              subPath: config.yaml
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: 'app'
                      operator: In
                      values:
                        - devbox-frontend
                topologyKey: 'kubernetes.io/hostname'
      volumes:
        - name: devbox-frontend-volume
          configMap:
            name: devbox-frontend-config
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: devbox-frontend
  name: devbox-frontend
  namespace: devbox-frontend
spec:
  ports:
    - name: http
      port: 3000
      protocol: TCP
      targetPort: 3000
  selector:
    app: devbox-frontend
