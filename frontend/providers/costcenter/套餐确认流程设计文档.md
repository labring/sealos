# 套餐确认流程设计文档

## 整体流程架构

### 页面层级结构

```
/pages/plan/index.tsx (Plan页面)
├── PlanHeader组件
│   └── UpgradePlanDialog (大弹窗)
│       └── PlansDisplay
│           ├── UpgradePlanCard × N (主套餐卡片)
│           │   ├── PlanConfirmationModal (升级/创建确认弹窗)
│           │   └── DowngradeModal (降级确认弹窗)
│           └── More Plans选择
│               ├── PlanConfirmationModal (升级/创建确认弹窗)
│               └── DowngradeModal (降级确认弹窗)
└── BalanceSection组件
```

## 关键函数逻辑

### 1. Plan 页面核心函数 - `handleSubscribe`

```typescript
// /pages/plan/index.tsx:202-292
const handleSubscribe = async (
  plan: SubscriptionPlan | null,
  workspaceName?: string,
  isPayg?: boolean
) => {
  if (isCreateMode) {
    // Create模式：创建workspace
    if (!workspaceName?.trim()) {
      // 验证workspace名称
      return;
    }

    if (isPayg) {
      // PAYG模式：按量付费workspace
      const paymentRequest = {
        workspace: '', // API会填充
        regionDomain: region?.domain || '',
        planName: 'Free',
        period: '1m',
        payMethod: 'balance',
        operator: 'created',
        createWorkspace: {
          teamName: workspaceName.trim(),
          userType: 'payg'
        }
      };
      // 注意：API会创建workspace但跳过subscription payment调用
      subscriptionMutation.mutate(paymentRequest);
    } else if (plan) {
      // 订阅模式：创建workspace + 订阅套餐
      const paymentRequest = {
        workspace: '',
        regionDomain: region?.domain || '',
        planName: plan.Name,
        period: '1m',
        payMethod: 'stripe',
        operator: 'created',
        createWorkspace: {
          teamName: workspaceName.trim(),
          userType: 'subscription'
        }
      };
      subscriptionMutation.mutate(paymentRequest);
    }
    return;
  }

  // Upgrade模式：升级现有workspace套餐
  const currentPlanObj = plansData?.data?.plans?.find(
    (p) => p.Name === subscriptionData?.data?.subscription?.PlanName
  );

  const getOperator = () => {
    if (!currentPlanObj) return 'upgraded';
    if (currentPlanObj.UpgradePlanList?.includes(plan.Name)) return 'upgraded';
    if (currentPlanObj.DowngradePlanList?.includes(plan.Name)) return 'downgraded';
    return 'upgraded';
  };

  const paymentRequest = {
    workspace: session.user.nsid,
    regionDomain: region.domain,
    planName: plan.Name,
    period: '1m',
    payMethod: 'stripe',
    operator: getOperator()
  };

  subscriptionMutation.mutate(paymentRequest);
};
```

### 2. 套餐卡片点击逻辑 - `handleSubscribeClick`

```typescript
// /components/plan/UpgradePlanCard.tsx:77-94
const handleSubscribeClick = () => {
  if (isCreateMode) {
    // Create模式：先选择套餐，再显示确认Modal
    onSelect?.(); // 选择当前套餐
    confirmationModalRef.current?.onOpen(); // 显示确认Modal
    return;
  }

  if (isCurrentPlan || isNextPlan || actionType === 'contact') {
    return; // 无操作情况
  }

  // 升级模式：根据操作类型显示对应Modal
  if (getOperator() === 'upgraded') {
    confirmationModalRef.current?.onOpen(); // 升级显示确认Modal
  } else {
    downgradeModalRef.current?.onOpen(); // 降级显示警告Modal
  }
};
```

### 3. More Plans 选择逻辑

```typescript
// /components/plan/PlansDisplay.tsx:198-212
onClick={() => {
  const plan = additionalPlans.find((p) => p.ID === selectedPlan);
  if (plan) {
    if (isCreateMode) {
      onSubscribe?.(plan); // Create模式直接调用
    } else {
      setPendingPlan(plan);
      // 判断升级还是降级
      const isUpgrade = currentPlanObj?.UpgradePlanList?.includes(plan.Name);
      if (isUpgrade) {
        confirmationModalRef.current?.onOpen(); // 升级显示确认Modal
      } else {
        downgradeModalRef.current?.onOpen(); // 降级显示警告Modal
      }
    }
  }
}}
```

### 4. 确认 Modal 逻辑

#### PlanConfirmationModal (升级/创建确认)

```typescript
// /components/plan/PlanConfirmationModal.tsx:52-67
// 费用计算Query - 仅升级模式调用API
const { data: upgradeAmountData, isLoading: amountLoading } = useQuery({
  queryKey: ['upgrade-amount', plan?.Name, workspace, regionDomain, period, payMethod, operator],
  queryFn: () => {
    if (!plan || !workspace || !regionDomain || operator !== 'upgraded') return null;
    return getUpgradeAmount({
      workspace,
      regionDomain,
      planName: plan.Name,
      period,
      payMethod,
      operator: 'upgraded'
    });
  },
  enabled: isOpen && !!(plan && workspace && regionDomain && operator === 'upgraded')
});

// 费用显示逻辑
const dueToday = isCreateMode ? monthlyPrice : upgradeAmount;
```

#### DowngradeModal (降级警告确认)

```typescript
// /components/plan/DowngradeModal.tsx:29-37
// 资源使用量Query - 降级时调用API检查资源使用情况
const { data: quotaResponse, isLoading } = useQuery({
  queryKey: ['workspace-quota', session?.user?.nsid, region?.uid],
  queryFn: () =>
    getWorkspaceQuota({
      regionUid: region?.uid || '',
      workspace: session?.user?.nsid || ''
    }),
  enabled: isOpen && !!(session?.user?.nsid && region?.uid),
  staleTime: 30000
});

// 资源超限检查逻辑
const checkResourceExceeded = (quota) => {
  return quota.some((item) => item.used > targetPlanLimit);
};
```

## 完整用户流程

### 场景 A: 新建 Workspace + 订阅套餐

```
1. 用户访问 /plan?mode=create
2. 点击 PlanHeader 中的 "Create Workspace" 按钮
3. 打开 UpgradePlanDialog (大弹窗)
4. 输入 workspace 名称
5. 选择套餐卡片 (PlansDisplay → UpgradePlanCard)
   - 卡片显示 "Select plan" / "Create with this plan" 按钮
   - 点击按钮 → handleSubscribeClick() → onSelect() + confirmationModalRef.onOpen()
6. 显示 PlanConfirmationModal 确认弹窗
   - 显示套餐详情 (CPU/内存/存储/流量)
   - 显示完整月费作为 "Due today"
   - 显示 workspace 名称
   - 按钮文案: "Create Workspace"
7. 用户点击 "Create Workspace" → handleConfirm() → onConfirm()
8. 调用 handleSubscribe() 执行实际创建
9. API调用: /api/plan/pay (包含 createWorkspace 参数)

备选路径 - More Plans:
5b. 勾选 "More Plans" → 选择套餐 → 点击 "Create Workspace" → 直接调用 onSubscribe()
```

### 场景 B: 升级现有 Workspace 套餐

```
1. 用户在现有workspace点击 "Upgrade Plan"
2. 打开 UpgradePlanDialog (大弹窗)
3. 选择目标套餐 (PlansDisplay → UpgradePlanCard)
4. 点击套餐 → handleSubscribeClick() → confirmationModalRef.onOpen()
5. 显示 PlanConfirmationModal 确认弹窗
   - 显示套餐详情
   - 调用 /api/plan/upgrade-amount 计算差额
   - 显示差额作为 "Due today"
6. 用户点击 "Checkout" → handleConfirm() → onConfirm()
7. 调用 handleSubscribe() 执行实际升级
8. API调用: /api/plan/pay (升级现有workspace)
```

### 场景 C: 降级套餐

```
1-3. 同升级流程
4. 点击降级套餐 → handleSubscribeClick() → downgradeModalRef.onOpen()
5. 显示 DowngradeModal 警告弹窗
   - 调用 /api/workspace/get-workspace-quota 获取资源使用量
   - 检查当前使用量是否超过目标套餐限制
   - 显示资源对比 (CPU、内存等)
   - 如果超限显示警告和清理时间
6. 用户点击 "Downgrade Plan" → handleConfirm() → onConfirm()
7. 调用 handleSubscribe() 执行实际降级
8. API调用: /api/plan/pay (降级现有workspace)
```

## 确认 Modal 设计要点

### PlanConfirmationModal 显示内容

- **标题**: Create Workspace / Subscribe Plan
- **套餐信息**: 名称 + 月费
- **资源配置**: CPU、内存、存储、流量 (带蓝色勾选图标)
- **费用明细**:
  - Total billed monthly: 月费
  - Due today: Create 模式显示完整月费，Upgrade 模式显示差额
- **Workspace 名称**: 仅 Create 模式显示
- **按钮**: Create Workspace / Checkout

### DowngradeModal 显示内容

- **标题**: We are sorry to see you go
- **资源警告**: 仅当资源超限时显示橙色警告区域
- **降级影响**: 动态显示资源对比 (当前限制 → 目标限制)
- **超限标识**: 超限资源红色标记 + 当前使用量
- **计费信息**:
  - 显示真实的下个计费周期时间 (`subscription.CurrentPeriodEndAt`)
  - 当前套餐在到期前保持活跃
- **按钮**: Keep Plan / Downgrade Plan

### 费用计算逻辑

- **Create 模式**: `dueToday = monthlyPrice` (完整月费)
- **Upgrade 模式**: `dueToday = upgradeAmount` (API 计算的按比例差额)
- **API 调用**: 仅 Upgrade 模式调用 `/api/plan/upgrade-amount`

### 组件复用策略

- 每个 `UpgradePlanCard` 都包含：
  - 一个 `PlanConfirmationModal` (升级/创建确认)
  - 一个 `DowngradeModal` (降级警告)
- `PlansDisplay` 的 More Plans 也有独立的两个 Modal：
  - `PlanConfirmationModal` (升级/创建确认)
  - `DowngradeModal` (降级警告)
- 通过操作类型自动选择显示对应的 Modal

### DowngradeModal 双实例原因

**为什么 DowngradeModal 出现在两个地方？**

1. **UpgradePlanCard 中的实例**: 处理**主套餐卡片**的降级操作

   - 数据来源: 直接使用卡片的 `plan` prop
   - 触发方式: 点击卡片按钮 → `handleSubscribeClick()`

2. **PlansDisplay 中的实例**: 处理**More Plans 下拉选择**的降级操作
   - 数据来源: 使用 `pendingPlan` state (从下拉选择设置)
   - 触发方式: 下拉选择 → 点击按钮 → 检测操作类型

这种设计确保了**两种不同的用户交互路径**都能正确显示降级警告，同时保持组件状态的独立性。

## API 数据转换

### PaymentMethod 类型转换

- **前端**: 使用小写 `['stripe', 'balance']`
- **API 层**: 转换为大写发送给后端服务
- **转换位置**:
  - `/api/plan/upgrade-amount.ts:38` - `payMethod.toUpperCase()`
  - `/api/plan/pay.ts:127` - `payMethod.toUpperCase()`

### 资源使用量数据转换

**WorkspaceQuota API 响应格式**:

```json
{
  "quota": [
    { "type": "cpu", "limit": 2000, "used": 0 }, // 毫核 (millicores)
    { "type": "memory", "limit": 2048, "used": 0 }, // MB
    { "type": "storage", "limit": 5120, "used": 0 }, // MB
    { "type": "traffic", "limit": 1073741824, "used": 0 }, // 字节
    { "type": "nodeport", "limit": 10, "used": 0 } // 个数
  ]
}
```

**前端显示转换**:

- CPU: `millicores / 1000` → Core
- Memory: `bytes / (1024³)` → GB
- Storage: `bytes / (1024³)` → GB
- Traffic: `bytes / (1024²)` → GB

## 关键技术决策

1. **焦点管理**: 使用 shadcn-ui Dialog 替代 Chakra UI Modal 避免 FocusLock 冲突
2. **状态管理**: 使用 useRef + useImperativeHandle 模式控制 Modal 开关
3. **数据流**: 单向数据流，确认后调用父组件的 onSubscribe 函数
4. **错误处理**: 完整的表单验证和 API 错误处理
5. **用户体验**: 升级和新建需要确认，**降级需要警告确认** (已更新)
6. **资源检查**: 降级前检查资源使用量，超限时显示警告
7. **API 优化**: 使用 React Query 管理 API 调用和缓存
8. **数据传递**: 完整的 subscription 对象传递，包含过期时间等详细信息
9. **Create 模式交互**: 主套餐卡片显示按钮，支持选择+确认的两步流程

## DowngradeModal 新增功能

### 核心特性

- **实时资源检查**: 调用 `/api/workspace/get-workspace-quota` 获取当前使用量
- **智能警告**: 仅在资源超限时显示橙色警告区域
- **动态对比**: 显示 `当前套餐限制 → 目标套餐限制` 的资源变化
- **超限标识**: 超限资源用红色标识，并显示当前使用量

### 双实例设计原因

- **路径分离**: 主套餐卡片 vs More Plans 选择器有不同的数据流
- **状态独立**: 避免多个交互路径之间的状态冲突
- **组件复用**: 相同的降级逻辑在不同场景下复用

这个设计确保了用户在所有重要操作前都有明确的确认步骤，降级时能看到详细的资源影响分析。
